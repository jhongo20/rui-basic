<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Editar Intermediario | RUI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link.active { background-color: #3f51b5; color: white !important; }
        .nav-tabs .nav-link { color: #3f51b5; }
        .progress { height: 5px; margin-bottom: 20px; }
        .tab-content { padding: 20px; }
        .btn-primary { background-color: #3f51b5; border-color: #3f51b5; }
        .btn-primary:hover { background-color: #303f9f; border-color: #303f9f; }
        .btn-secondary { background-color: #f8f9fa; border-color: #ddd; color: #333; }
        .btn-secondary:hover { background-color: #e9ecef; border-color: #ccc; color: #333; }
        .table th { background-color: #f8f9fa; color: #333; font-weight: 500; }
        .table td { vertical-align: middle; }
        .btn-link { padding: 0.25rem 0.5rem; text-decoration: none; }
        .btn-link:hover { background-color: #f8f9fa; border-radius: 4px; }
        .form-check-input { margin: 0; }
        .observation-icon { color: #dc3545; margin-left: 5px; cursor: pointer; }
        .view-only-badge {
            background-color: #f8f9fa;
            color: #3f51b5;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Input oculto para el ID del intermediario -->
    <input type="hidden" id="intermediaryId" th:value="${intermediary.id}">

    <!-- Contenedor para los mensajes toast -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3"></div>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img th:src="@{/img/mintrabajo_logo.png}" height="35" alt="MinTrabajo">
                <img th:src="@{/img/nuevopais_logo.png}" height="60" alt="Nuevo País">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
                    aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto">
                    <!-- Opciones que NO se muestran para Intermediario -->
                    <li class="nav-item" th:if="${!#authentication.authorities[0].authority.equals('Intermediario')}">
                        <a class="nav-link" th:href="@{/dashboard}" th:classappend="${activeTab == 'dashboard' ? 'active fw-bold' : ''}">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item" th:if="${!#authentication.authorities[0].authority.equals('Intermediario')}">
                        <a class="nav-link" th:href="@{/intermediary/list}" th:classappend="${activeTab == 'intermediaryList' ? 'active fw-bold' : ''}">
                            <i class="fas fa-list me-1"></i> Listado de Intermediarios
                        </a>
                    </li>
                    
                    <!-- Opción "Mis Registros" visible para todos los roles -->
                    <li class="nav-item" th:if="${#authentication.authorities[0].authority.equals('Intermediario')}">
                        <a class="nav-link" th:href="@{/intermediary/my-registries}" th:classappend="${activeTab == 'myRegistries' ? 'active fw-bold' : ''}">
                            <i class="fas fa-folder-open me-1"></i> Mis Registros
                        </a>
                    </li>
                    
                    <!-- Cerrar sesión siempre visible -->
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/logout}">
                            <i class="fas fa-sign-out-alt me-1"></i> Cerrar sesión
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4>FORMULARIO ÚNICO DE INTERMEDIARIOS DE SEGUROS EN EL RAMO DE RIESGOS LABORALES</h4>
                    <p>TIPO DE INTERMEDIARIO: <span th:text="${intermediary != null && intermediary.typeIntermediarieId != null ? intermediary.typeIntermediarieId.value : 'No disponible'}"></span></p>
                </div>
                <a th:href="@{/intermediary/my-registries}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Volver a Mis Registros
                </a>
            </div>
            <div class="card-body" th:if="${intermediary != null}">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#general">Información General</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#idoneidad">Idoneidad Profesional</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#human">Infraestructura Humana</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#operational">Infraestructura Operativa</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#digital">Firma Digitalizada</button></li>
                </ul>

                <form th:action="@{/intermediary/complement/{id}(id=${intermediary.id})}" th:object="${intermediary}" method="post" enctype="multipart/form-data">
                    <div class="tab-content">
                        <!-- Tab de Información General -->
                        <div class="tab-pane fade show active" id="general">
                            <div class="progress mb-4"><div class="progress-bar" style="width: 20%"></div></div>
                            <h5 class="card-title">Información General</h5>
                            
                            <!-- Sección para empresas (no agentes) -->
                            <div th:unless="${isAgente}">
                                <!-- NIT -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">NIT: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{companyId.nit}" required maxlength="10">
                                            <button th:if="${fieldStates != null && fieldStates['nit'] != null && fieldStates['nit'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('nit', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Razón Social -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Razón Social: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{companyId.name}" required maxlength="160">
                                            <button th:if="${fieldStates != null && fieldStates['business_name'] != null && fieldStates['business_name'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('business_name', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Departamento -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Departamento: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <select class="form-select" th:field="*{companyId.departmentId.id}" required id="departmentSelect" onchange="loadCities()">
                                                <option value="">Seleccione...</option>
                                                <option th:each="dept : ${departments}" th:value="${dept.id}" th:text="${dept.name}"></option>
                                            </select>
                                            <button th:if="${fieldStates != null && fieldStates['department_id'] != null && fieldStates['department_id'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('department_id', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ciudad -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Ciudad: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <select class="form-select" th:field="*{companyId.cityId.id}" required id="citySelect">
                                                <option value="">Seleccione...</option>
                                                <option th:each="city : ${cities}" th:value="${city.id}" th:text="${city.name}" 
                                                        th:attr="data-department=${city.department != null ? city.department.id : ''}"></option>
                                            </select>
                                            <button th:if="${fieldStates != null && fieldStates['city_id'] != null && fieldStates['city_id'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('city_id', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dirección -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Dirección: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{companyId.address}" required maxlength="50">
                                            <button th:if="${fieldStates != null && fieldStates['address'] != null && fieldStates['address'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('address', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Correo electrónico -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Correo electrónico: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="email" class="form-control" th:field="*{companyId.email}" required maxlength="200">
                                            <button th:if="${fieldStates != null && fieldStates['email'] != null && fieldStates['email'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('email', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Teléfono Fijo -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Teléfono Fijo: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{companyId.phone}" required maxlength="7">
                                            <button th:if="${fieldStates != null && fieldStates['phone'] != null && fieldStates['phone'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('phone', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección para agentes -->
                            <div th:if="${isAgente}">
                                <!-- Tipo de Documento -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Tipo de Documento: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.documentType}" required maxlength="50">
                                            <button th:if="${fieldStates != null && fieldStates['document_type'] != null && fieldStates['document_type'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('document_type', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Número de Documento -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Número de Documento: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.documentNumber}" required maxlength="15">
                                            <button th:if="${fieldStates != null && fieldStates['document_number'] != null && fieldStates['document_number'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('document_number', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Primer Nombre -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Primer Nombre: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.firstName}" required maxlength="25">
                                            <button th:if="${fieldStates != null && fieldStates['first_name'] != null && fieldStates['first_name'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('first_name', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Segundo Nombre -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Segundo Nombre:</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.secondName}" maxlength="25">
                                            <button th:if="${fieldStates != null && fieldStates['second_name'] != null && fieldStates['second_name'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('second_name', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Primer Apellido -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Primer Apellido: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.firstSurname}" required maxlength="25">
                                            <button th:if="${fieldStates != null && fieldStates['first_surname'] != null && fieldStates['first_surname'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('first_surname', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Segundo Apellido -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Segundo Apellido:</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.secondSurname}" maxlength="25">
                                            <button th:if="${fieldStates != null && fieldStates['second_surname'] != null && fieldStates['second_surname'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('second_surname', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Departamento -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Departamento: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <select class="form-select" th:field="*{personId.departmentId.id}" required id="personDepartmentSelect" onchange="loadPersonCities()">
                                                <option value="">Seleccione...</option>
                                                <option th:each="dept : ${departments}" th:value="${dept.id}" th:text="${dept.name}"></option>
                                            </select>
                                            <button th:if="${fieldStates != null && fieldStates['department_id'] != null && fieldStates['department_id'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('department_id', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ciudad -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Ciudad: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <select class="form-select" th:field="*{personId.cityId.id}" required id="personCitySelect">
                                                <option value="">Seleccione...</option>
                                                <option th:each="city : ${cities}" th:value="${city.id}" th:text="${city.name}"
                                                        th:attr="data-department=${city.department != null ? city.department.id : ''}"></option>
                                            </select>
                                            <button th:if="${fieldStates != null && fieldStates['city_id'] != null && fieldStates['city_id'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('city_id', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dirección -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Dirección: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.address}" required maxlength="50">
                                            <button th:if="${fieldStates != null && fieldStates['address'] != null && fieldStates['address'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('address', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Correo electrónico -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Correo electrónico: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="email" class="form-control" th:field="*{personId.email}" required maxlength="200">
                                            <button th:if="${fieldStates != null && fieldStates['email'] != null && fieldStates['email'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('email', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Teléfono Fijo -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Teléfono Fijo: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.phone}" required maxlength="7">
                                            <button th:if="${fieldStates != null && fieldStates['phone'] != null && fieldStates['phone'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('phone', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Teléfono Móvil -->
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Teléfono Móvil: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{personId.cellphone}" required maxlength="10">
                                            <button th:if="${fieldStates != null && fieldStates['cellphone'] != null && fieldStates['cellphone'].iconClose}" 
                                                  class="btn btn-outline-secondary observation-icon" 
                                                  type="button" 
                                                  onclick="viewObservation('cellphone', event)" 
                                                  title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button class="btn btn-primary" type="button" onclick="cambiarTab('idoneidad')">Siguiente <i class="fas fa-arrow-right ms-2"></i></button>
                            </div>
                        </div>

                        <!-- Tab de Idoneidad Profesional -->
                        <!-- Tab de Idoneidad Profesional -->
                        <div class="tab-pane fade" id="idoneidad">
                            <div class="progress mb-4"><div class="progress-bar" style="width: 40%"></div></div>
                            <h5>Datos de Idoneidad Profesional</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Tipo Identificación</th>
                                            <th>No. Identificación</th>
                                            <th>Primer Nombre</th>
                                            <th>Segundo Nombre</th>
                                            <th>Primer Apellido</th>
                                            <th>Segundo Apellido</th>
                                            <th>Entidad curso</th>
                                            <th>Fecha curso</th>
                                            <th>Soporte</th>
                                            <th>Observación</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="idoniedad, iterStat : ${idoneidadList}">
                                            <input type="hidden" th:name="'idoneidadIds[' + ${iterStat.index} + ']'" th:value="${idoniedad.id}" />
                                            <td><input type="text" class="form-control" th:name="'idoneidadDocumentTypes[' + ${iterStat.index} + ']'" th:value="${idoniedad.documentType}" /></td>
                                            <td><input type="text" class="form-control" th:name="'idoneidadDocumentNumbers[' + ${iterStat.index} + ']'" th:value="${idoniedad.documentNumber}" /></td>
                                            <td><input type="text" class="form-control" th:name="'idoneidadFirstNames[' + ${iterStat.index} + ']'" th:value="${idoniedad.firstName}" /></td>
                                            <td><input type="text" class="form-control" th:name="'idoneidadSecondNames[' + ${iterStat.index} + ']'" th:value="${idoniedad.secondName}" /></td>
                                            <td><input type="text" class="form-control" th:name="'idoneidadFirstSurnames[' + ${iterStat.index} + ']'" th:value="${idoniedad.firstSurname}" /></td>
                                            <td><input type="text" class="form-control" th:name="'idoneidadSecondSurnames[' + ${iterStat.index} + ']'" th:value="${idoniedad.secondSurname}" /></td>
                                            <td><input type="text" class="form-control" th:name="'idoneidadCourseEntities[' + ${iterStat.index} + ']'" th:value="${idoniedad.courseEntity}" /></td>
                                            <td><input type="date" class="form-control" th:name="'idoneidadDateCourses[' + ${iterStat.index} + ']'" th:value="${idoniedad.dateCourse != null ? #dates.format(idoniedad.dateCourse, 'yyyy-MM-dd') : ''}" /></td>
                                            <td class="text-center">
                                                <input type="file" class="form-control" th:name="'idoneidadFiles[' + ${iterStat.index} + ']'" accept=".pdf,.jpg,.jpeg,.png" />
                                                <div th:if="${idoniedad.supportUpload}" class="mt-2">
                                                    <a th:href="@{/api/idoniedad/{id}/download(id=${idoniedad.id})}" class="btn btn-link btn-sm"><i class="fas fa-file-download"></i> Ver actual</a>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <div class="observation-view-only" th:attr="data-idoniedad-id=${idoniedad.id}">
                                                    <button class="btn btn-outline-secondary observation-icon view-observation"
                                                            type="button"
                                                            th:onclick="|viewObservation(null, event, ${idoniedad.id})|"
                                                            style="display: none;"
                                                            title="Ver observación">
                                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" type="button" onclick="cambiarTab('general')"><i class="fas fa-arrow-left me-2"></i>Atrás</button>
                                <button class="btn btn-primary" type="button" onclick="cambiarTab('human')">Siguiente <i class="fas fa-arrow-right ms-2"></i></button>
                            </div>
                        </div>

                        <!-- Tab de Infraestructura Humana -->
                        <!-- Tab de Infraestructura Humana -->
                        <div class="tab-pane fade" id="human">
                            <div class="progress mb-4"><div class="progress-bar" style="width: 60%"></div></div>
                            <h5>Infraestructura Humana</h5>
                            <div th:unless="${isAgente}" th:if="${intermediary.infrastructureHumanId != null}">
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Tipo de Documento: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{infrastructureHumanId.lawyerId.documentType}" required maxlength="50">
                                            <div class="observation-view-only" data-field="infra_document_type">
                                                <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                        type="button" 
                                                        onclick="viewObservation('infra_document_type', event)" 
                                                        style="display: none;" 
                                                        title="Ver observación">
                                                    <i class="fas fa-exclamation-circle text-danger"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Número de Documento: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{infrastructureHumanId.lawyerId.documentNumber}" required maxlength="15">
                                            <div class="observation-view-only" data-field="infra_document_number">
                                                <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                        type="button" 
                                                        onclick="viewObservation('infra_document_number', event)" 
                                                        style="display: none;" 
                                                        title="Ver observación">
                                                    <i class="fas fa-exclamation-circle text-danger"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Primer Nombre: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{infrastructureHumanId.lawyerId.firstName}" required maxlength="25">
                                            <div class="observation-view-only" data-field="infra_first_name">
                                                <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                        type="button" 
                                                        onclick="viewObservation('infra_first_name', event)" 
                                                        style="display: none;" 
                                                        title="Ver observación">
                                                    <i class="fas fa-exclamation-circle text-danger"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Segundo Nombre:</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{infrastructureHumanId.lawyerId.secondName}" maxlength="25">
                                            <div class="observation-view-only" data-field="infra_second_name">
                                                <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                        type="button" 
                                                        onclick="viewObservation('infra_second_name', event)" 
                                                        style="display: none;" 
                                                        title="Ver observación">
                                                    <i class="fas fa-exclamation-circle text-danger"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Primer Apellido: *</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{infrastructureHumanId.lawyerId.firstSurname}" required maxlength="25">
                                            <div class="observation-view-only" data-field="infra_first_surname">
                                                <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                        type="button" 
                                                        onclick="viewObservation('infra_first_surname', event)" 
                                                        style="display: none;" 
                                                        title="Ver observación">
                                                    <i class="fas fa-exclamation-circle text-danger"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Segundo Apellido:</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input type="text" class="form-control" th:field="*{infrastructureHumanId.lawyerId.secondSurname}" maxlength="25">
                                            <div class="observation-view-only" data-field="infra_second_surname">
                                                <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                        type="button" 
                                                        onclick="viewObservation('infra_second_surname', event)" 
                                                        style="display: none;" 
                                                        title="Ver observación">
                                                    <i class="fas fa-exclamation-circle text-danger"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tabla de experiencias laborales (sin cambios) -->
                            <div class="table-responsive mt-4" th:if="${experienciasLaborales != null && !experienciasLaborales.isEmpty()}">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Empresa</th>
                                            <th>Cargo</th>
                                            <th>Nombre del jefe</th>
                                            <th>Teléfono del jefe</th>
                                            <th>Fecha inicio</th>
                                            <th>Fecha fin</th>
                                            <th>Soporte</th>
                                            <th>Observación</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="exp, iterStat : ${experienciasLaborales}">
                                            <input type="hidden" th:name="'workExperienceIds[' + ${iterStat.index} + ']'" th:value="${exp.id}" />
                                            <td><input type="text" class="form-control" th:name="'workExperienceCompanies[' + ${iterStat.index} + ']'" th:value="${exp.company}" /></td>
                                            <td><input type="text" class="form-control" th:name="'workExperienceCharges[' + ${iterStat.index} + ']'" th:value="${exp.charge}" /></td>
                                            <td><input type="text" class="form-control" th:name="'workExperienceNameBosses[' + ${iterStat.index} + ']'" th:value="${exp.nameBoss}" /></td>
                                            <td><input type="text" class="form-control" th:name="'workExperiencePhoneBosses[' + ${iterStat.index} + ']'" th:value="${exp.phoneBoss}" maxlength="10" /></td>
                                            <td><input type="date" class="form-control" th:name="'workExperienceStartDates[' + ${iterStat.index} + ']'" th:value="${#dates.format(exp.startDate, 'yyyy-MM-dd')}" /></td>
                                            <td><input type="date" class="form-control" th:name="'workExperienceEndDates[' + ${iterStat.index} + ']'" th:value="${#dates.format(exp.endDate, 'yyyy-MM-dd')}" /></td>
                                            <td class="text-center">
                                                <input type="file" class="form-control" th:name="'workExperienceFiles[' + ${iterStat.index} + ']'" accept=".pdf,.jpg,.jpeg,.png" />
                                                <div th:if="${exp.supportUpload}" class="mt-2">
                                                    <a th:href="@{/intermediary/workexperience/{id}/download(id=${exp.id})}" class="btn btn-link btn-sm"><i class="fas fa-file-download"></i> Ver actual</a>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <div class="observation-view-only" th:attr="data-work-exp-id=${exp.id}">
                                                    <button class="btn btn-outline-secondary observation-icon view-observation"
                                                            type="button"
                                                            th:onclick="|viewObservation('work_exp', event, ${exp.id})|"
                                                            style="display: none;"
                                                            title="Ver observación">
                                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info" th:if="${experienciasLaborales == null || experienciasLaborales.isEmpty()}">
                                No hay experiencias laborales registradas.
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" type="button" onclick="cambiarTab('idoneidad')"><i class="fas fa-arrow-left me-2"></i>Atrás</button>
                                <button class="btn btn-primary" type="button" onclick="cambiarTab('operational')">Siguiente <i class="fas fa-arrow-right ms-2"></i></button>
                            </div>
                        </div>

                        <!-- Tab de Infraestructura Operativa -->
                        <!-- Tab de Infraestructura Operativa -->
                        <div class="tab-pane fade" id="operational">
                            <div class="progress mb-4"><div class="progress-bar" style="width: 80%"></div></div>
                            <h5>Infraestructura Operativa</h5>
                            
                            <!-- Soportes -->
                            <div class="row mb-4">
                                <label class="col-sm-4 col-form-label">Soporte Cámara de Comercio: *</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="file" class="form-control" name="ccFile" accept=".pdf,.jpg,.jpeg,.png">
                                        <div class="observation-view-only" data-field="operativa_camara">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_camara', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div th:if="${infraestructuraOperativa != null && infraestructuraOperativa.camaraComercioUploaded}" class="mt-2">
                                        <a th:href="@{/intermediary/infraoperativa/soporte/camara/{id}(id=${infraestructuraOperativa.id})}" class="btn btn-link btn-sm"><i class="fas fa-file-download"></i> Ver actual</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <label class="col-sm-4 col-form-label">Soporte Software: *</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="file" class="form-control" name="softFile" accept=".pdf,.jpg,.jpeg,.png">
                                        <div class="observation-view-only" data-field="operativa_software">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_software', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div th:if="${infraestructuraOperativa != null && infraestructuraOperativa.softwareCertificationUploaded}" class="mt-2">
                                        <a th:href="@{/intermediary/infraoperativa/soporte/software/{id}(id=${infraestructuraOperativa.id})}" class="btn btn-link btn-sm"><i class="fas fa-file-download"></i> Ver actual</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <label class="col-sm-4 col-form-label">Soporte Equipos: *</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="file" class="form-control" name="hardFile" accept=".pdf,.jpg,.jpeg,.png">
                                        <div class="observation-view-only" data-field="operativa_equipos">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_equipos', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div th:if="${infraestructuraOperativa != null && infraestructuraOperativa.equiposTecnologicosUploaded}" class="mt-2">
                                        <a th:href="@{/intermediary/infraoperativa/soporte/equipos/{id}(id=${infraestructuraOperativa.id})}" class="btn btn-link btn-sm"><i class="fas fa-file-download"></i> Ver actual</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campos de información -->
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Línea telefónica 1: *</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" th:field="*{infrastructureOperationalId.phone1}" required maxlength="10">
                                        <div class="observation-view-only" data-field="operativa_phone1">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_phone1', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Línea telefónica 2:</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" th:field="*{infrastructureOperationalId.phone2}" maxlength="10">
                                        <div class="observation-view-only" data-field="operativa_phone2">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_phone2', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Línea telefónica 3:</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" th:field="*{infrastructureOperationalId.phone3}" maxlength="10">
                                        <div class="observation-view-only" data-field="operativa_phone3">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_phone3', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Número del Fax:</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" th:field="*{infrastructureOperationalId.phoneFax}" maxlength="7">
                                        <div class="observation-view-only" data-field="operativa_phone_fax">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_phone_fax', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Correo Electrónico: *</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="email" class="form-control" th:field="*{infrastructureOperationalId.email}" required maxlength="200">
                                        <div class="observation-view-only" data-field="operativa_email">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_email', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Dirección Oficina: *</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" th:field="*{infrastructureOperationalId.addressServiceOffice}" required maxlength="50">
                                        <div class="observation-view-only" data-field="operativa_address">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('operativa_address', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" type="button" onclick="cambiarTab('human')"><i class="fas fa-arrow-left me-2"></i>Atrás</button>
                                <button class="btn btn-primary" type="button" onclick="cambiarTab('digital')">Siguiente <i class="fas fa-arrow-right ms-2"></i></button>
                            </div>
                        </div>

                        <!-- Tab de Firma Digitalizada -->
                        <!-- Tab de Firma Digitalizada -->
                        <div class="tab-pane fade" id="digital">
                            <div class="progress mb-4"><div class="progress-bar" style="width: 100%"></div></div>
                            <h5>Firma Digitalizada</h5>
                            
                            <div class="row mb-4">
                                <label class="col-sm-3 col-form-label">Firma Digitalizada: *</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="file" class="form-control" name="signatureFile" accept=".jpg,.jpeg,.png">
                                        <div class="observation-view-only" data-field="firma_digitalizada">
                                            <button class="btn btn-outline-secondary observation-icon view-observation" 
                                                    type="button" 
                                                    onclick="viewObservation('firma_digitalizada', event)" 
                                                    style="display: none;" 
                                                    title="Ver observación">
                                                <i class="fas fa-exclamation-circle text-danger"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div th:if="${firmaDigitalizada != null}" class="mt-3 text-center">
                                        <p>Firma actual:</p>
                                        <img th:src="@{/intermediary/firma/{id}(id=${intermediary.id})}" alt="Firma Actual" class="img-fluid border" style="max-width: 400px;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" type="button" onclick="cambiarTab('operational')"><i class="fas fa-arrow-left me-2"></i>Atrás</button>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Guardar Cambios</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card-body" th:if="${intermediary == null}">
                <p class="text-danger">No se encontró el registro del intermediario.</p>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar las observaciones -->
    <!-- Modal de observaciones -->
<div class="modal fade" id="viewObservationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewObservationTitle">Observación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="viewObservationText" rows="3" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
<script th:src="@{/js/observation-edit.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Filtrar ciudades según departamento seleccionado
            if (document.getElementById('departmentSelect')) {
                document.getElementById('departmentSelect').addEventListener('change', function() {
                    loadCities();
                });
            }
            
            if (document.getElementById('personDepartmentSelect')) {
                document.getElementById('personDepartmentSelect').addEventListener('change', function() {
                    loadPersonCities();
                });
            }
            
            // Cargar ciudades iniciales
            if (document.getElementById('departmentSelect')) {
                loadCities();
            }
            
            if (document.getElementById('personDepartmentSelect')) {
                loadPersonCities();
            }
        });
        
        // Función para cambiar tabs
        function cambiarTab(tabId) {
            const tabElem = document.querySelector(`[data-bs-target="#${tabId}"]`);
            if (tabElem) {
                const tab = new bootstrap.Tab(tabElem);
                tab.show();
            }
        }
        
        // Función para cargar ciudades según departamento (para empresa)
        function loadCities() {
            const departmentSelect = document.getElementById('departmentSelect');
            const citySelect = document.getElementById('citySelect');
            
            if (!departmentSelect || !citySelect) return;
            
            const selectedDeptId = departmentSelect.value;
            const cityOptions = citySelect.querySelectorAll('option');
            
            // Ocultar todas las ciudades
            for (let i = 0; i < cityOptions.length; i++) {
                const cityOption = cityOptions[i];
                if (cityOption.value === '') {
                    cityOption.style.display = '';
                    continue;
                }
                
                const deptId = cityOption.getAttribute('data-department');
                if (deptId === selectedDeptId) {
                    cityOption.style.display = '';
                } else {
                    cityOption.style.display = 'none';
                }
            }
            
            // Resetear la selección si la ciudad no pertenece al departamento
            const currentCityOption = citySelect.querySelector(`option[value="${citySelect.value}"]`);
            if (currentCityOption && currentCityOption.style.display === 'none') {
                citySelect.value = '';
            }
        }
        
        // Función para cargar ciudades según departamento (para persona)
        function loadPersonCities() {
            const departmentSelect = document.getElementById('personDepartmentSelect');
            const citySelect = document.getElementById('personCitySelect');
            
            if (!departmentSelect || !citySelect) return;
            
            const selectedDeptId = departmentSelect.value;
            const cityOptions = citySelect.querySelectorAll('option');
            
            // Ocultar todas las ciudades
            for (let i = 0; i < cityOptions.length; i++) {
                const cityOption = cityOptions[i];
                if (cityOption.value === '') {
                    cityOption.style.display = '';
                    continue;
                }
                
                const deptId = cityOption.getAttribute('data-department');
                if (deptId === selectedDeptId) {
                    cityOption.style.display = '';
                } else {
                    cityOption.style.display = 'none';
                }
            }
            
            // Resetear la selección si la ciudad no pertenece al departamento
            const currentCityOption = citySelect.querySelector(`option[value="${citySelect.value}"]`);
            if (currentCityOption && currentCityOption.style.display === 'none') {
                citySelect.value = '';
            }
        }
        
       
    </script>
    <script>
        // Sobrescribir viewObservation para usar el endpoint correcto en idoneidad
        function viewObservation(field, event, id = null) {
            if (event) event.preventDefault();
    
            const intermediaryId = document.getElementById('intermediaryId').value;
            let url;
            let title;
    
            if (field === 'work_exp' && id) {
                url = `/intermediary/workexp/${id}/observation`;
                title = 'Experiencia Laboral';
            } else if (id) {
                url = `/api/idoniedad/${id}/observation`; // Endpoint correcto
                title = 'Registro de Idoneidad';
            } else if (field) {
                url = `/intermediary/field-observation/${intermediaryId}/${field}`;
                title = getFieldLabel(field);
            } else {
                console.error('No se proporcionó field ni id');
                return;
            }
    
            // Mostrar el modal con mensaje de carga
            document.getElementById('viewObservationText').value = "Cargando observación...";
            document.getElementById('viewObservationTitle').textContent = `Observación sobre ${title}`;
            const viewModal = new bootstrap.Modal(document.getElementById('viewObservationModal'));
            viewModal.show();
    
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('No se encontró observación para este campo');
                        }
                        throw new Error('Error al cargar observación');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('viewObservationText').value = data.observation || "No hay observación disponible";
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('viewObservationText').value = error.message || "Error al cargar la observación";
                });
        }
    
        // Redefinir getFieldLabel para mantener consistencia
        function getFieldLabel(field) {
            if (field === 'work_exp') return 'Experiencia Laboral';
            if (!field) return 'Registro de Idoneidad';
            
            const labels = {
                'nit': 'NIT',
                'business_name': 'Razón Social',
                'department_id': 'Departamento',
                'city_id': 'Ciudad',
                'address': 'Dirección',
                'email': 'Correo electrónico',
                'phone': 'Teléfono Fijo',
                'document_type': 'Tipo de Identificación',
                'document_number': 'No. Identificación',
                'first_name': 'Primer Nombre',
                'second_name': 'Segundo Nombre',
                'first_surname': 'Primer Apellido',
                'second_surname': 'Segundo Apellido',
                'cellphone': 'Teléfono Móvil',
                'infra_document_type': 'Tipo de Documento (Infraestructura)',
                'infra_document_number': 'Número de Documento (Infraestructura)',
                'infra_first_name': 'Primer Nombre (Infraestructura)',
                'infra_second_name': 'Segundo Nombre (Infraestructura)',
                'infra_first_surname': 'Primer Apellido (Infraestructura)',
                'infra_second_surname': 'Segundo Apellido (Infraestructura)',
                'operativa_camara': 'Soporte matrícula de cámara de comercio',
                'operativa_software': 'Soporte de certificación de Software o Base de Datos',
                'operativa_equipos': 'Soporte de certificación de equipos tecnológicos',
                'operativa_phone1': 'Línea telefónica 1',
                'operativa_phone2': 'Línea telefónica 2',
                'operativa_phone3': 'Línea telefónica 3',
                'operativa_phone_fax': 'Número del Fax',
                'operativa_email': 'Correo Electrónico (Operativa)',
                'operativa_address': 'Dirección de oficina de atención al ciudadano',
                'firma_digitalizada': 'Firma Digitalizada'
            };
            return labels[field] || field;
        }
    </script>

</body>
</html>